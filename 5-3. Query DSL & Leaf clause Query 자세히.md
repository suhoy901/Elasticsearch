# Query DSL(Domain Specific Language)

- JSON 기반의 Elasticsearch 쿼리를 정의하는 언어





## shakespear 데이터 준비

- 25000개의 문서를 대상으로 실험

~~~
$ curl -H 'Content-Type: application/x-ndjson' -XPOST 'localhost:9200/shakespeare/doc/_bulk?pretty' --data-binary @shakespeare_6.0.json
~~~



### termvectors

- frequency와 어떤 토큰이 생성되었는지 확인이 가능한 api

~~~
POST /shakespeare/_doc/gPezC3ABFjKEo3V5Mu-2/_termvectors
{
  "fields": [
    "text_entry"
  ],
  "offsets": true,
  "payloads": true,
  "positions": true,
  "term_statistics": true,
  "field_statistics": true
}


#! Deprecation: [types removal] Specifying types in term vector requests is deprecated.
{
  "_index" : "shakespeare",
  "_type" : "_doc",
  "_id" : "gPezC3ABFjKEo3V5Mu-2",
  "_version" : 0,
  "found" : false,
  "took" : 1
}

~~~



### URI Search

- URI 에 request parameters 를 통해 검색 질의

- 한정된 검색 옵션만 사용 가능(Quick Test)

- Score 없음

- 아래의 예시
  - from=0 : 가장 score가 높은 것 부터
  - size=100 : 100개까지 리턴
  - text entry 필드 : mother
  - line_id 필드 : asc(오름차순)

~~~
GET shakespeare/_search?from=0&size=100&q=text_entry:mother&sort=line_id:asc


{
  "took" : 38,
  "timed_out" : false,
  "_shards" : {
    "total" : 3,
    "successful" : 3,
    "skipped" : 0,
    "failed" : 0
  },
  "hits" : {
    "total" : {
      "value" : 60,
      "relation" : "eq"
    },
    "max_score" : null,
    "hits" : [
      {
        "_index" : "shakespeare",
        "_type" : "doc",
        "_id" : "YVuXTXABDdPMBukX18jo",
        "_score" : null,
        "_source" : {
          "type" : "line",
          "line_id" : 1282,
          "play_name" : "Henry IV",
          "speech_number" : 108,
          "line_number" : "2.4.278",
          "speaker" : "PRINCE HENRY",
          "text_entry" : "send him back again to my mother."
        },
        "sort" : [
          1282
        ]
      },
      {
        "_index" : "shakespeare",
        "_type" : "doc",
        "_id" : "-VuXTXABDdPMBukX19Dw",
        "_score" : null,
        "_source" : {
          "type" : "line",
          "line_id" : 3482,
          "play_name" : "Henry VI Part 1",
          "speech_number" : 18,
          "line_number" : "1.2.79",
          "speaker" : "JOAN LA PUCELLE",
          "text_entry" : "Gods mother deigned to appear to me"
        },
        "sort" : [
          3482
        ]
      },
      {
        "_index" : "shakespeare",
        "_type" : "doc",
        "_id" : "F1uXTXABDdPMBukX19Hx",
        "_score" : null,
        "_source" : {
          "type" : "line",
          "line_id" : 3512,
          "play_name" : "Henry VI Part 1",
          "speech_number" : 24,
          "line_number" : "1.2.108",
          "speaker" : "JOAN LA PUCELLE",
          "text_entry" : "Christs mother helps me, else I were too weak."
        },
        "sort" : [
          3512
        ]
      },
      {
        "_index" : "shakespeare",
        "_type" : "doc",
        "_id" : "O1uXTXABDdPMBukX19Hx",
        "_score" : null,
        "_source" : {
          "type" : "line",
          "line_id" : 3548,
          "play_name" : "Henry VI Part 1",
          "speech_number" : 36,
          "line_number" : "1.2.144",
          "speaker" : "CHARLES",
          "text_entry" : "Helen, the mother of great Constantine,"
        },
        "sort" : [
          3548
        ]
      },
      {
        "_index" : "shakespeare",
        "_type" : "doc",
        "_id" : "dVuXTXABDdPMBukX19Ty",
        "_score" : null,
        "_source" : {
          "type" : "line",
          "line_id" : 4374,
          "play_name" : "Henry VI Part 1",
          "speech_number" : 11,
          "line_number" : "2.5.77",
          "speaker" : "MORTIMER",
          "text_entry" : "For by my mother I derived am"
        },
        "sort" : [
          4374
        ]
      },
      ...
      ...
      ...
~~~



### Request Body Search

~~~
# Request Body Search
POST shakespeare/_search
{
  "query": {
    "term": {
      "play_name.keyword": "Henry IV"
    }
  }
}



{
  "took" : 8,
  "timed_out" : false,
  "_shards" : {
    "total" : 3,
    "successful" : 3,
    "skipped" : 0,
    "failed" : 0
  },
  "hits" : {
    "total" : {
      "value" : 3203,
      "relation" : "eq"
    },
    "max_score" : 2.0982885,
    "hits" : [
      {
        "_index" : "shakespeare",
        "_type" : "doc",
        "_id" : "YFuXTXABDdPMBukX18Pj",
        "_score" : 2.0982885,
        "_source" : {
          "type" : "act",
          "line_id" : 1,
          "play_name" : "Henry IV",
          "speech_number" : "",
          "line_number" : "",
          "speaker" : "",
          "text_entry" : "ACT I"
        }
      },
      {
        "_index" : "shakespeare",
        "_type" : "doc",
        "_id" : "ZFuXTXABDdPMBukX18Pj",
        "_score" : 2.0982885,
        "_source" : {
          "type" : "line",
          "line_id" : 5,
          "play_name" : "Henry IV",
          "speech_number" : 1,
          "line_number" : "1.1.2",
          "speaker" : "KING HENRY IV",
          "text_entry" : "Find we a time for frighted peace to pant,"
        }
      },
      {
        "_index" : "shakespeare",
        "_type" : "doc",
        "_id" : "Z1uXTXABDdPMBukX18Pj",
        "_score" : 2.0982885,
        "_source" : {
          "type" : "line",
          "line_id" : 8,
          "play_name" : "Henry IV",
          "speech_number" : 1,
          "line_number" : "1.1.5",
          "speaker" : "KING HENRY IV",
          "text_entry" : "No more the thirsty entrance of this soil"
        }
      },
      {
        "_index" : "shakespeare",
        "_type" : "doc",
        "_id" : "a1uXTXABDdPMBukX18Pj",
        "_score" : 2.0982885,
        "_source" : {
          "type" : "line",
          "line_id" : 12,
          "play_name" : "Henry IV",
          "speech_number" : 1,
          "line_number" : "1.1.9",
          "speaker" : "KING HENRY IV",
          "text_entry" : "Of hostile paces: those opposed eyes,"
        }
      },
      {
        "_index" : "shakespeare",
        "_type" : "doc",
        "_id" : "bFuXTXABDdPMBukX18Pj",
        "_score" : 2.0982885,
        "_source" : {
          "type" : "line",
          "line_id" : 13,
          "play_name" : "Henry IV",
          "speech_number" : 1,
          "line_number" : "1.1.10",
          "speaker" : "KING HENRY IV",
          "text_entry" : "Which, like the meteors of a troubled heaven,"
        }
      },
      {
        "_index" : "shakespeare",
        "_type" : "doc",
        "_id" : "dFuXTXABDdPMBukX18Pj",
        "_score" : 2.0982885,
        "_source" : {
          "type" : "line",
          "line_id" : 21,
          "play_name" : "Henry IV",
          "speech_number" : 1,
          "line_number" : "1.1.18",
          "speaker" : "KING HENRY IV",
          "text_entry" : "No more shall cut his master. Therefore, friends,"
        }
      },
      {
        "_index" : "shakespeare",
        "_type" : "doc",
        "_id" : "dluXTXABDdPMBukX18Pj",
        "_score" : 2.0982885,
        "_source" : {
          "type" : "line",
          "line_id" : 23,
          "play_name" : "Henry IV",
          "speech_number" : 1,
          "line_number" : "1.1.20",
          "speaker" : "KING HENRY IV",
          "text_entry" : "Whose soldier now, under whose blessed cross"
        }
      },
      {
        "_index" : "shakespeare",
        "_type" : "doc",
        "_id" : "fFuXTXABDdPMBukX18Pj",
        "_score" : 2.0982885,
        "_source" : {
          "type" : "line",
          "line_id" : 29,
          "play_name" : "Henry IV",
          "speech_number" : 1,
          "line_number" : "1.1.26",
          "speaker" : "KING HENRY IV",
          "text_entry" : "Which fourteen hundred years ago were naild"
        }
      },
      {
        "_index" : "shakespeare",
        "_type" : "doc",
        "_id" : "fVuXTXABDdPMBukX18Pj",
        "_score" : 2.0982885,
        "_source" : {
          "type" : "line",
          "line_id" : 30,
          "play_name" : "Henry IV",
          "speech_number" : 1,
          "line_number" : "1.1.27",
          "speaker" : "KING HENRY IV",
          "text_entry" : "For our advantage on the bitter cross."
        }
      },
      {
        "_index" : "shakespeare",
        "_type" : "doc",
        "_id" : "gluXTXABDdPMBukX18Pj",
        "_score" : 2.0982885,
        "_source" : {
          "type" : "line",
          "line_id" : 35,
          "play_name" : "Henry IV",
          "speech_number" : 1,
          "line_number" : "1.1.32",
          "speaker" : "KING HENRY IV",
          "text_entry" : "What yesternight our council did decree"
        }
      }
    ]
  }
}
~~~



### Pagination

- match query를 사용해서 text_entry 필드에서 가장 스코어가 높은 녀석부터 2개를 리턴해라

~~~
## 1. Pagination
POST shakespeare/_search
{
  "from": 0,
  "size": 2,
  "query": {
    "match": {
      "text_entry": "my mother"
    }
  }
}


{
  "took" : 20,
  "timed_out" : false,
  "_shards" : {
    "total" : 3,
    "successful" : 3,
    "skipped" : 0,
    "failed" : 0
  },
  "hits" : {
    "total" : {
      "value" : 2574,
      "relation" : "eq"
    },
    "max_score" : 10.115345,
    "hits" : [
      {
        "_index" : "shakespeare",
        "_type" : "doc",
        "_id" : "o1uXTXABDdPMBukX1-T6",
        "_score" : 10.115345,
        "_source" : {
          "type" : "line",
          "line_id" : 8516,
          "play_name" : "Henry VI Part 2",
          "speech_number" : 23,
          "line_number" : "4.2.36",
          "speaker" : "CADE",
          "text_entry" : "My mother a Plantagenet,--"
        }
      },
      {
        "_index" : "shakespeare",
        "_type" : "doc",
        "_id" : "e1uXTXABDdPMBukX2PkE",
        "_score" : 9.41773,
        "_source" : {
          "type" : "line",
          "line_id" : 13852,
          "play_name" : "Alls well that ends well",
          "speech_number" : 106,
          "line_number" : "2.3.289",
          "speaker" : "BERTRAM",
          "text_entry" : "Acquaint my mother with my hate to her,"
        }
      }
    ]
  }
}


# 2. max pagination size 변경 : 10001개
PUT shakespeare/_settings
{
  "index.max_result_window": 10001
}


{
  "acknowledged" : true
}


## 3. sort
POST shakespeare/_search
{
  "sort": {
    "line_id": "desc"
  }
}


{
  "took" : 21,
  "timed_out" : false,
  "_shards" : {
    "total" : 3,
    "successful" : 3,
    "skipped" : 0,
    "failed" : 0
  },
  "hits" : {
    "total" : {
      "value" : 10000,
      "relation" : "gte"
    },
    "max_score" : null,
    "hits" : [
      {
        "_index" : "shakespeare",
        "_type" : "doc",
        "_id" : "B1yXTXABDdPMBukX2CUa",
        "_score" : null,
        "_source" : {
          "type" : "line",
          "line_id" : 25000,
          "play_name" : "Coriolanus",
          "speech_number" : 16,
          "line_number" : "1.4.35",
          "speaker" : "MARCIUS",
          "text_entry" : "Which makes me sweat with wrath. Come on, my fellows:"
        },
        "sort" : [
          25000
        ]
      },
      {
        "_index" : "shakespeare",
        "_type" : "doc",
        "_id" : "BlyXTXABDdPMBukX2CUa",
        "_score" : null,
        "_source" : {
          "type" : "line",
          "line_id" : 24999,
          "play_name" : "Coriolanus",
          "speech_number" : 16,
          "line_number" : "1.4.34",
          "speaker" : "MARCIUS",
          "text_entry" : "They do disdain us much beyond our thoughts,"
        },
        "sort" : [
          24999
        ]
      },
      {
        "_index" : "shakespeare",
        "_type" : "doc",
        "_id" : "BVyXTXABDdPMBukX2CUa",
        "_score" : null,
        "_source" : {
          "type" : "line",
          "line_id" : 24998,
          "play_name" : "Coriolanus",
          "speech_number" : 16,
          "line_number" : "1.4.33",
          "speaker" : "MARCIUS",
          "text_entry" : "brave Titus:"
        },
        "sort" : [
          24998
        ]
      },
      {
        "_index" : "shakespeare",
        "_type" : "doc",
        "_id" : "BFyXTXABDdPMBukX2CUa",
        "_score" : null,
        "_source" : {
          "type" : "line",
          "line_id" : 24997,
          "play_name" : "Coriolanus",
          "speech_number" : 16,
          "line_number" : "1.4.32",
          "speaker" : "MARCIUS",
          "text_entry" : "With hearts more proof than shields. Advance,"
        },
        "sort" : [
          24997
        ]
      },
      {
        "_index" : "shakespeare",
        "_type" : "doc",
        "_id" : "A1yXTXABDdPMBukX2CUa",
        "_score" : null,
        "_source" : {
          "type" : "line",
          "line_id" : 24996,
          "play_name" : "Coriolanus",
          "speech_number" : 16,
          "line_number" : "1.4.31",
          "speaker" : "MARCIUS",
          "text_entry" : "Now put your shields before your hearts, and fight"
        },
        "sort" : [
          24996
        ]
      },
      {
        "_index" : "shakespeare",
        "_type" : "doc",
        "_id" : "AlyXTXABDdPMBukX2CUa",
        "_score" : null,
        "_source" : {
          "type" : "line",
          "line_id" : 24995,
          "play_name" : "Coriolanus",
          "speech_number" : 16,
          "line_number" : "1.4.30",
          "speaker" : "MARCIUS",
          "text_entry" : "They fear us not, but issue forth their city."
        },
        "sort" : [
          24995
        ]
      },
      {
        "_index" : "shakespeare",
        "_type" : "doc",
        "_id" : "AVyXTXABDdPMBukX2CUa",
        "_score" : null,
        "_source" : {
          "type" : "line",
          "line_id" : 24994,
          "play_name" : "Coriolanus",
          "speech_number" : 15,
          "line_number" : "",
          "speaker" : "LARTIUS",
          "text_entry" : "Enter the army of the Volsces"
        },
        "sort" : [
          24994
        ]
      },
      {
        "_index" : "shakespeare",
        "_type" : "doc",
        "_id" : "AFyXTXABDdPMBukX2CUa",
        "_score" : null,
        "_source" : {
          "type" : "line",
          "line_id" : 24993,
          "play_name" : "Coriolanus",
          "speech_number" : 15,
          "line_number" : "1.4.29",
          "speaker" : "LARTIUS",
          "text_entry" : "Their noise be our instruction. Ladders, ho!"
        },
        "sort" : [
          24993
        ]
      },
      {
        "_index" : "shakespeare",
        "_type" : "doc",
        "_id" : "_1yXTXABDdPMBukX2CQa",
        "_score" : null,
        "_source" : {
          "type" : "line",
          "line_id" : 24992,
          "play_name" : "Coriolanus",
          "speech_number" : 14,
          "line_number" : "1.4.28",
          "speaker" : "MARCIUS",
          "text_entry" : "O, they are at it!"
        },
        "sort" : [
          24992
        ]
      },
      {
        "_index" : "shakespeare",
        "_type" : "doc",
        "_id" : "_lyXTXABDdPMBukX2CQa",
        "_score" : null,
        "_source" : {
          "type" : "line",
          "line_id" : 24991,
          "play_name" : "Coriolanus",
          "speech_number" : 13,
          "line_number" : "1.4.27",
          "speaker" : "First Senator",
          "text_entry" : "Amongst your cloven army."
        },
        "sort" : [
          24991
        ]
      }
    ]
  }
}
~~~



### explain

- explain을 사용하는 경우 score가 계산되는 방식을 함께 보여줌

~~~
# 스코어 계산방식
POST shakespeare/_search
{
  "explain": true,
  "from": 0,
  "size": 2,
  "query": {
    "match": {
      "text_entry": "my mother"
    }
  }
}
~~~



### source filtering

~~~
POST shakespeare/_search
{
  "_source": false,
  "sort": {
    "line_id": "desc"
  }
}


{
  "took" : 5,
  "timed_out" : false,
  "_shards" : {
    "total" : 3,
    "successful" : 3,
    "skipped" : 0,
    "failed" : 0
  },
  "hits" : {
    "total" : {
      "value" : 10000,
      "relation" : "gte"
    },
    "max_score" : null,
    "hits" : [
      {
        "_index" : "shakespeare",
        "_type" : "doc",
        "_id" : "B1yXTXABDdPMBukX2CUa",
        "_score" : null,
        "sort" : [
          25000
        ]
      },
      {
        "_index" : "shakespeare",
        "_type" : "doc",
        "_id" : "BlyXTXABDdPMBukX2CUa",
        "_score" : null,
        "sort" : [
          24999
        ]
      },
      {
        "_index" : "shakespeare",
        "_type" : "doc",
        "_id" : "BVyXTXABDdPMBukX2CUa",
        "_score" : null,
        "sort" : [
          24998
        ]
      },
      {
        "_index" : "shakespeare",
        "_type" : "doc",
        "_id" : "BFyXTXABDdPMBukX2CUa",
        "_score" : null,
        "sort" : [
          24997
        ]
      },
      {
        "_index" : "shakespeare",
        "_type" : "doc",
        "_id" : "A1yXTXABDdPMBukX2CUa",
        "_score" : null,
        "sort" : [
          24996
        ]
      },
      {
        "_index" : "shakespeare",
        "_type" : "doc",
        "_id" : "AlyXTXABDdPMBukX2CUa",
        "_score" : null,
        "sort" : [
          24995
        ]
      },
      {
        "_index" : "shakespeare",
        "_type" : "doc",
        "_id" : "AVyXTXABDdPMBukX2CUa",
        "_score" : null,
        "sort" : [
          24994
        ]
      },
      {
        "_index" : "shakespeare",
        "_type" : "doc",
        "_id" : "AFyXTXABDdPMBukX2CUa",
        "_score" : null,
        "sort" : [
          24993
        ]
      },
      {
        "_index" : "shakespeare",
        "_type" : "doc",
        "_id" : "_1yXTXABDdPMBukX2CQa",
        "_score" : null,
        "sort" : [
          24992
        ]
      },
      {
        "_index" : "shakespeare",
        "_type" : "doc",
        "_id" : "_lyXTXABDdPMBukX2CQa",
        "_score" : null,
        "sort" : [
          24991
        ]
      }
    ]
  }
}
~~~



#### 2. source filtering

- 복수의 source를 설정하는 경우

~~~
POST shakespeare/_search
{
  "_source": [
    "speaker",
    "text_entry"
  ],
  "sort": {
    "line_id": "desc"
  }
}


{
  "took" : 8,
  "timed_out" : false,
  "_shards" : {
    "total" : 3,
    "successful" : 3,
    "skipped" : 0,
    "failed" : 0
  },
  "hits" : {
    "total" : {
      "value" : 10000,
      "relation" : "gte"
    },
    "max_score" : null,
    "hits" : [
      {
        "_index" : "shakespeare",
        "_type" : "doc",
        "_id" : "B1yXTXABDdPMBukX2CUa",
        "_score" : null,
        "_source" : {
          "text_entry" : "Which makes me sweat with wrath. Come on, my fellows:",
          "speaker" : "MARCIUS"
        },
        "sort" : [
          25000
        ]
      },
      {
        "_index" : "shakespeare",
        "_type" : "doc",
        "_id" : "BlyXTXABDdPMBukX2CUa",
        "_score" : null,
        "_source" : {
          "text_entry" : "They do disdain us much beyond our thoughts,",
          "speaker" : "MARCIUS"
        },
        "sort" : [
          24999
        ]
      },
      {
        "_index" : "shakespeare",
        "_type" : "doc",
        "_id" : "BVyXTXABDdPMBukX2CUa",
        "_score" : null,
        "_source" : {
          "text_entry" : "brave Titus:",
          "speaker" : "MARCIUS"
        },
        "sort" : [
          24998
        ]
      },
      {
        "_index" : "shakespeare",
        "_type" : "doc",
        "_id" : "BFyXTXABDdPMBukX2CUa",
        "_score" : null,
        "_source" : {
          "text_entry" : "With hearts more proof than shields. Advance,",
          "speaker" : "MARCIUS"
        },
        "sort" : [
          24997
        ]
      },
      {
        "_index" : "shakespeare",
        "_type" : "doc",
        "_id" : "A1yXTXABDdPMBukX2CUa",
        "_score" : null,
        "_source" : {
          "text_entry" : "Now put your shields before your hearts, and fight",
          "speaker" : "MARCIUS"
        },
        "sort" : [
          24996
        ]
      },
      {
        "_index" : "shakespeare",
        "_type" : "doc",
        "_id" : "AlyXTXABDdPMBukX2CUa",
        "_score" : null,
        "_source" : {
          "text_entry" : "They fear us not, but issue forth their city.",
          "speaker" : "MARCIUS"
        },
        "sort" : [
          24995
        ]
      },
      {
        "_index" : "shakespeare",
        "_type" : "doc",
        "_id" : "AVyXTXABDdPMBukX2CUa",
        "_score" : null,
        "_source" : {
          "text_entry" : "Enter the army of the Volsces",
          "speaker" : "LARTIUS"
        },
        "sort" : [
          24994
        ]
      },
      {
        "_index" : "shakespeare",
        "_type" : "doc",
        "_id" : "AFyXTXABDdPMBukX2CUa",
        "_score" : null,
        "_source" : {
          "text_entry" : "Their noise be our instruction. Ladders, ho!",
          "speaker" : "LARTIUS"
        },
        "sort" : [
          24993
        ]
      },
      {
        "_index" : "shakespeare",
        "_type" : "doc",
        "_id" : "_1yXTXABDdPMBukX2CQa",
        "_score" : null,
        "_source" : {
          "text_entry" : "O, they are at it!",
          "speaker" : "MARCIUS"
        },
        "sort" : [
          24992
        ]
      },
      {
        "_index" : "shakespeare",
        "_type" : "doc",
        "_id" : "_lyXTXABDdPMBukX2CQa",
        "_score" : null,
        "_source" : {
          "text_entry" : "Amongst your cloven army.",
          "speaker" : "First Senator"
        },
        "sort" : [
          24991
        ]
      }
    ]
  }
}
~~~



#### 3. source filtering

- 와일드 카드를 사용하는 경우

~~~
POST shakespeare/_search
{
  "_source": [
    "*num*"
  ],
  "sort": {
    "line_id": "desc"
  }
}


{
  "took" : 8,
  "timed_out" : false,
  "_shards" : {
    "total" : 3,
    "successful" : 3,
    "skipped" : 0,
    "failed" : 0
  },
  "hits" : {
    "total" : {
      "value" : 10000,
      "relation" : "gte"
    },
    "max_score" : null,
    "hits" : [
      {
        "_index" : "shakespeare",
        "_type" : "doc",
        "_id" : "B1yXTXABDdPMBukX2CUa",
        "_score" : null,
        "_source" : {
          "speech_number" : 16,
          "line_number" : "1.4.35"
        },
        "sort" : [
          25000
        ]
      },
      {
        "_index" : "shakespeare",
        "_type" : "doc",
        "_id" : "BlyXTXABDdPMBukX2CUa",
        "_score" : null,
        "_source" : {
          "speech_number" : 16,
          "line_number" : "1.4.34"
        },
        "sort" : [
          24999
        ]
      },
      {
        "_index" : "shakespeare",
        "_type" : "doc",
        "_id" : "BVyXTXABDdPMBukX2CUa",
        "_score" : null,
        "_source" : {
          "speech_number" : 16,
          "line_number" : "1.4.33"
        },
        "sort" : [
          24998
        ]
      },
      {
        "_index" : "shakespeare",
        "_type" : "doc",
        "_id" : "BFyXTXABDdPMBukX2CUa",
        "_score" : null,
        "_source" : {
          "speech_number" : 16,
          "line_number" : "1.4.32"
        },
        "sort" : [
          24997
        ]
      },
      {
        "_index" : "shakespeare",
        "_type" : "doc",
        "_id" : "A1yXTXABDdPMBukX2CUa",
        "_score" : null,
        "_source" : {
          "speech_number" : 16,
          "line_number" : "1.4.31"
        },
        "sort" : [
          24996
        ]
      },
      {
        "_index" : "shakespeare",
        "_type" : "doc",
        "_id" : "AlyXTXABDdPMBukX2CUa",
        "_score" : null,
        "_source" : {
          "speech_number" : 16,
          "line_number" : "1.4.30"
        },
        "sort" : [
          24995
        ]
      },
      {
        "_index" : "shakespeare",
        "_type" : "doc",
        "_id" : "AVyXTXABDdPMBukX2CUa",
        "_score" : null,
        "_source" : {
          "speech_number" : 15,
          "line_number" : ""
        },
        "sort" : [
          24994
        ]
      },
      {
        "_index" : "shakespeare",
        "_type" : "doc",
        "_id" : "AFyXTXABDdPMBukX2CUa",
        "_score" : null,
        "_source" : {
          "speech_number" : 15,
          "line_number" : "1.4.29"
        },
        "sort" : [
          24993
        ]
      },
      {
        "_index" : "shakespeare",
        "_type" : "doc",
        "_id" : "_1yXTXABDdPMBukX2CQa",
        "_score" : null,
        "_source" : {
          "speech_number" : 14,
          "line_number" : "1.4.28"
        },
        "sort" : [
          24992
        ]
      },
      {
        "_index" : "shakespeare",
        "_type" : "doc",
        "_id" : "_lyXTXABDdPMBukX2CQa",
        "_score" : null,
        "_source" : {
          "speech_number" : 13,
          "line_number" : "1.4.27"
        },
        "sort" : [
          24991
        ]
      }
    ]
  }
}
~~~



### highlight

- highlight 로 검색 결과 하이라이팅

~~~
## 데이터를 찾고싶은 경우 많이 사용
POST shakespeare/_search
{
  "_source": [
    "play_name",
    "speaker",
    "text_entry"
  ],
  "query": {
    "query_string": {
      "query": "henry"
    }
  },
  "highlight": {
    "fields": {
      "speaker": {}
    }
  }
}


{
  "took" : 93,
  "timed_out" : false,
  "_shards" : {
    "total" : 3,
    "successful" : 3,
    "skipped" : 0,
    "failed" : 0
  },
  "hits" : {
    "total" : {
      "value" : 10000,
      "relation" : "gte"
    },
    "max_score" : 6.5824065,
    "hits" : [
      {
        "_index" : "shakespeare",
        "_type" : "doc",
        "_id" : "hluXTXABDdPMBukX18rr",
        "_score" : 6.5824065,
        "_source" : {
          "play_name" : "Henry IV",
          "text_entry" : "Enter KING HENRY IV, PRINCE HENRY, and others",
          "speaker" : "MORTIMER"
        }
      },
      {
        "_index" : "shakespeare",
        "_type" : "doc",
        "_id" : "D1uXTXABDdPMBukX18zs",
        "_score" : 6.5760736,
        "_source" : {
          "play_name" : "Henry IV",
          "text_entry" : "Exit PRINCE HENRY",
          "speaker" : "PRINCE HENRY"
        },
        "highlight" : {
          "speaker" : [
            "PRINCE <em>HENRY</em>"
          ]
        }
      },
      {
        "_index" : "shakespeare",
        "_type" : "doc",
        "_id" : "3FuXTXABDdPMBukX187v",
        "_score" : 6.5760736,
        "_source" : {
          "play_name" : "Henry IV",
          "text_entry" : "Enter PRINCE HENRY",
          "speaker" : "FALSTAFF"
        }
      },
      {
        "_index" : "shakespeare",
        "_type" : "doc",
        "_id" : "L1uXTXABDdPMBukX187v",
        "_score" : 6.2616215,
        "_source" : {
          "play_name" : "Henry IV",
          "text_entry" : "Exit PRINCE HENRY",
          "speaker" : "PRINCE HENRY"
        },
        "highlight" : {
          "speaker" : [
            "PRINCE <em>HENRY</em>"
          ]
        }
      },
      {
        "_index" : "shakespeare",
        "_type" : "doc",
        "_id" : "c1uXTXABDdPMBukX18_w",
        "_score" : 6.2616215,
        "_source" : {
          "play_name" : "Henry IV",
          "text_entry" : "Exit PRINCE HENRY",
          "speaker" : "PRINCE HENRY"
        },
        "highlight" : {
          "speaker" : [
            "PRINCE <em>HENRY</em>"
          ]
        }
      },
      {
        "_index" : "shakespeare",
        "_type" : "doc",
        "_id" : "KluXTXABDdPMBukX1-L5",
        "_score" : 6.129874,
        "_source" : {
          "play_name" : "Henry VI Part 2",
          "text_entry" : "KING HENRY VI swoons",
          "speaker" : "CARDINAL"
        }
      },
      {
        "_index" : "shakespeare",
        "_type" : "doc",
        "_id" : "IVuXTXABDdPMBukX18_v",
        "_score" : 5.9382772,
        "_source" : {
          "play_name" : "Henry IV",
          "text_entry" : "They fight. KING HENRY being in danger, PRINCE HENRY enters",
          "speaker" : "EARL OF DOUGLAS"
        }
      },
      {
        "_index" : "shakespeare",
        "_type" : "doc",
        "_id" : "BFuXTXABDdPMBukX2PEA",
        "_score" : 5.838947,
        "_source" : {
          "play_name" : "Henry VI Part 3",
          "text_entry" : "They all cry, Henry!",
          "speaker" : "WARWICK"
        }
      },
      {
        "_index" : "shakespeare",
        "_type" : "doc",
        "_id" : "lVuXTXABDdPMBukX18bm",
        "_score" : 5.7403784,
        "_source" : {
          "play_name" : "Henry IV",
          "text_entry" : "Exeunt PRINCE HENRY and POINS",
          "speaker" : "POINS"
        }
      },
      {
        "_index" : "shakespeare",
        "_type" : "doc",
        "_id" : "PluXTXABDdPMBukX18fn",
        "_score" : 5.7403784,
        "_source" : {
          "play_name" : "Henry IV",
          "text_entry" : "Enter PRINCE HENRY and POINS",
          "speaker" : "LADY PERCY"
        }
      }
    ]
  }
}
~~~





## Leaf query clause

- 자체적으로 쿼리를 할 수 있는 완성된 검색 쿼리 절

- **match, term, range 등...**



## Full Text Query(Query Context query)

- **쿼리문을 analyze 하여 검색. 스코어가 가장 높은 문서순으로 노출**
- **검색 쿼리 절이 얼마나 문서에 잘 매치되는지 유사성을 확인**
- 검색 쿼리와의 매칭율에 따라 **_score** 를 부여
  - ex) elastic search 검색 -> elastic 포함된 문서, search 포함된 문서 검색
- **match, match_phrase, match_phrase_prefix, query_string 등**
- 각 쿼리는 key:value 형태로 바로 검색하거나 쿼리 종류별로 제공하는 parameter 는 사용할 수 있음

- **쿼리 종류**
  - https://www.elastic.co/guide/en/elasticsearch/reference/current/full-text-queries.html
- **쿼리 별 파라미터**
  - https://opendistro.github.io/for-elasticsearch-docs/docs/elasticsearch/full-text/#options



### 1. match Query

- 쿼리문의 analyze 된 토큰으로 유사한 문서 검색
- key:value 형태 검색

~~~
# match query
POST shakespeare/_search
{
  "query": {
    "match": {
      "text_entry": "my mother"
    }
  }
}


{
  "took" : 8,
  "timed_out" : false,
  "_shards" : {
    "total" : 3,
    "successful" : 3,
    "skipped" : 0,
    "failed" : 0
  },
  "hits" : {
    "total" : {
      "value" : 2574,
      "relation" : "eq"
    },
    "max_score" : 10.115345,
    "hits" : [
      {
        "_index" : "shakespeare",
        "_type" : "doc",
        "_id" : "o1uXTXABDdPMBukX1-T6",
        "_score" : 10.115345,
        "_source" : {
          "type" : "line",
          "line_id" : 8516,
          "play_name" : "Henry VI Part 2",
          "speech_number" : 23,
          "line_number" : "4.2.36",
          "speaker" : "CADE",
          "text_entry" : "My mother a Plantagenet,--"
        }
      },
      {
        "_index" : "shakespeare",
        "_type" : "doc",
        "_id" : "e1uXTXABDdPMBukX2PkE",
        "_score" : 9.41773,
        "_source" : {
          "type" : "line",
          "line_id" : 13852,
          "play_name" : "Alls well that ends well",
          "speech_number" : 106,
          "line_number" : "2.3.289",
          "speaker" : "BERTRAM",
          "text_entry" : "Acquaint my mother with my hate to her,"
        }
      },
      {
        "_index" : "shakespeare",
        "_type" : "doc",
        "_id" : "gVuXTXABDdPMBukX19Ty",
        "_score" : 9.034084,
        "_source" : {
          "type" : "line",
          "line_id" : 4386,
          "play_name" : "Henry VI Part 1",
          "speech_number" : 11,
          "line_number" : "2.5.89",
          "speaker" : "MORTIMER",
          "text_entry" : "Marrying my sister that thy mother was,"
        }
      },
      {
        "_index" : "shakespeare",
        "_type" : "doc",
        "_id" : "bFuXTXABDdPMBukX19_3",
        "_score" : 9.034084,
        "_source" : {
          "type" : "line",
          "line_id" : 7181,
          "play_name" : "Henry VI Part 2",
          "speech_number" : 10,
          "line_number" : "2.2.45",
          "speaker" : "YORK",
          "text_entry" : "My mother, being heir unto the crown"
        }
      },
      {
        "_index" : "shakespeare",
        "_type" : "doc",
        "_id" : "wVuXTXABDdPMBukX2PwG",
        "_score" : 8.819458,
        "_source" : {
          "type" : "line",
          "line_id" : 14690,
          "play_name" : "Alls well that ends well",
          "speech_number" : 6,
          "line_number" : "4.2.15",
          "speaker" : "DIANA",
          "text_entry" : "My mother did but duty; such, my lord,"
        }
      },
      {
        "_index" : "shakespeare",
        "_type" : "doc",
        "_id" : "iluXTXABDdPMBukX2PQC",
        "_score" : 8.553913,
        "_source" : {
          "type" : "line",
          "line_id" : 12587,
          "play_name" : "Henry VI Part 3",
          "speech_number" : 15,
          "line_number" : "5.6.70",
          "speaker" : "GLOUCESTER",
          "text_entry" : "For I have often heard my mother say"
        }
      },
      {
        "_index" : "shakespeare",
        "_type" : "doc",
        "_id" : "YluXTXABDdPMBukX2P0G",
        "_score" : 8.553913,
        "_source" : {
          "type" : "line",
          "line_id" : 14851,
          "play_name" : "Alls well that ends well",
          "speech_number" : 31,
          "line_number" : "4.3.84",
          "speaker" : "BERTRAM",
          "text_entry" : "lady mother I am returning; entertained my convoy;"
        }
      },
      {
        "_index" : "shakespeare",
        "_type" : "doc",
        "_id" : "YVuXTXABDdPMBukX18jo",
        "_score" : 8.238523,
        "_source" : {
          "type" : "line",
          "line_id" : 1282,
          "play_name" : "Henry IV",
          "speech_number" : 108,
          "line_number" : "2.4.278",
          "speaker" : "PRINCE HENRY",
          "text_entry" : "send him back again to my mother."
        }
      },
      {
        "_index" : "shakespeare",
        "_type" : "doc",
        "_id" : "dVuXTXABDdPMBukX19Ty",
        "_score" : 8.238523,
        "_source" : {
          "type" : "line",
          "line_id" : 4374,
          "play_name" : "Henry VI Part 1",
          "speech_number" : 11,
          "line_number" : "2.5.77",
          "speaker" : "MORTIMER",
          "text_entry" : "For by my mother I derived am"
        }
      },
      {
        "_index" : "shakespeare",
        "_type" : "doc",
        "_id" : "uFuXTXABDdPMBukX2PYD",
        "_score" : 7.9560194,
        "_source" : {
          "type" : "line",
          "line_id" : 13145,
          "play_name" : "Alls well that ends well",
          "speech_number" : 44,
          "line_number" : "1.3.157",
          "speaker" : "HELENA",
          "text_entry" : "You are my mother, madam; would you were,--"
        }
      }
    ]
  }
}
~~~



### 2. boost 

~~~
# boost를 2로 설정할 경우 스코어가 2배
POST shakespeare/_search
{
  "query": {
    "match": {
      "text_entry": {
        "query": "my mother",
        "boost": 2 
      }
    }
  }
}


{
  "took" : 8,
  "timed_out" : false,
  "_shards" : {
    "total" : 3,
    "successful" : 3,
    "skipped" : 0,
    "failed" : 0
  },
  "hits" : {
    "total" : {
      "value" : 2574,
      "relation" : "eq"
    },
    "max_score" : 20.23069,
    "hits" : [
      {
        "_index" : "shakespeare",
        "_type" : "doc",
        "_id" : "o1uXTXABDdPMBukX1-T6",
        "_score" : 20.23069,
        "_source" : {
          "type" : "line",
          "line_id" : 8516,
          "play_name" : "Henry VI Part 2",
          "speech_number" : 23,
          "line_number" : "4.2.36",
          "speaker" : "CADE",
          "text_entry" : "My mother a Plantagenet,--"
        }
      },
      {
        "_index" : "shakespeare",
        "_type" : "doc",
        "_id" : "e1uXTXABDdPMBukX2PkE",
        "_score" : 18.83546,
        "_source" : {
          "type" : "line",
          "line_id" : 13852,
          "play_name" : "Alls well that ends well",
          "speech_number" : 106,
          "line_number" : "2.3.289",
          "speaker" : "BERTRAM",
          "text_entry" : "Acquaint my mother with my hate to her,"
        }
      },
      {
        "_index" : "shakespeare",
        "_type" : "doc",
        "_id" : "gVuXTXABDdPMBukX19Ty",
        "_score" : 18.068169,
        "_source" : {
          "type" : "line",
          "line_id" : 4386,
          "play_name" : "Henry VI Part 1",
          "speech_number" : 11,
          "line_number" : "2.5.89",
          "speaker" : "MORTIMER",
          "text_entry" : "Marrying my sister that thy mother was,"
        }
      },
      {
        "_index" : "shakespeare",
        "_type" : "doc",
        "_id" : "bFuXTXABDdPMBukX19_3",
        "_score" : 18.068169,
        "_source" : {
          "type" : "line",
          "line_id" : 7181,
          "play_name" : "Henry VI Part 2",
          "speech_number" : 10,
          "line_number" : "2.2.45",
          "speaker" : "YORK",
          "text_entry" : "My mother, being heir unto the crown"
        }
      },
      {
        "_index" : "shakespeare",
        "_type" : "doc",
        "_id" : "wVuXTXABDdPMBukX2PwG",
        "_score" : 17.638916,
        "_source" : {
          "type" : "line",
          "line_id" : 14690,
          "play_name" : "Alls well that ends well",
          "speech_number" : 6,
          "line_number" : "4.2.15",
          "speaker" : "DIANA",
          "text_entry" : "My mother did but duty; such, my lord,"
        }
      },
      {
        "_index" : "shakespeare",
        "_type" : "doc",
        "_id" : "iluXTXABDdPMBukX2PQC",
        "_score" : 17.107826,
        "_source" : {
          "type" : "line",
          "line_id" : 12587,
          "play_name" : "Henry VI Part 3",
          "speech_number" : 15,
          "line_number" : "5.6.70",
          "speaker" : "GLOUCESTER",
          "text_entry" : "For I have often heard my mother say"
        }
      },
      {
        "_index" : "shakespeare",
        "_type" : "doc",
        "_id" : "YluXTXABDdPMBukX2P0G",
        "_score" : 17.107826,
        "_source" : {
          "type" : "line",
          "line_id" : 14851,
          "play_name" : "Alls well that ends well",
          "speech_number" : 31,
          "line_number" : "4.3.84",
          "speaker" : "BERTRAM",
          "text_entry" : "lady mother I am returning; entertained my convoy;"
        }
      },
      {
        "_index" : "shakespeare",
        "_type" : "doc",
        "_id" : "YVuXTXABDdPMBukX18jo",
        "_score" : 16.477045,
        "_source" : {
          "type" : "line",
          "line_id" : 1282,
          "play_name" : "Henry IV",
          "speech_number" : 108,
          "line_number" : "2.4.278",
          "speaker" : "PRINCE HENRY",
          "text_entry" : "send him back again to my mother."
        }
      },
      {
        "_index" : "shakespeare",
        "_type" : "doc",
        "_id" : "dVuXTXABDdPMBukX19Ty",
        "_score" : 16.477045,
        "_source" : {
          "type" : "line",
          "line_id" : 4374,
          "play_name" : "Henry VI Part 1",
          "speech_number" : 11,
          "line_number" : "2.5.77",
          "speaker" : "MORTIMER",
          "text_entry" : "For by my mother I derived am"
        }
      },
      {
        "_index" : "shakespeare",
        "_type" : "doc",
        "_id" : "uFuXTXABDdPMBukX2PYD",
        "_score" : 15.912039,
        "_source" : {
          "type" : "line",
          "line_id" : 13145,
          "play_name" : "Alls well that ends well",
          "speech_number" : 44,
          "line_number" : "1.3.157",
          "speaker" : "HELENA",
          "text_entry" : "You are my mother, madam; would you were,--"
        }
      }
    ]
  }
}
~~~



### 3. match_phrase Query

- analyze 된 쿼리의 토큰을 순서대로 합쳐서 쿼리 구문을 만들어 검색

~~~
# match_phrase : 순서대로만 검색함
POST shakespeare/_search
{
  "query": {
    "match_phrase": {
      "text_entry": "my mother a"
    }
  }
}


{
  "took" : 10,
  "timed_out" : false,
  "_shards" : {
    "total" : 3,
    "successful" : 3,
    "skipped" : 0,
    "failed" : 0
  },
  "hits" : {
    "total" : {
      "value" : 1,
      "relation" : "eq"
    },
    "max_score" : 12.787695,
    "hits" : [
      {
        "_index" : "shakespeare",
        "_type" : "doc",
        "_id" : "o1uXTXABDdPMBukX1-T6",
        "_score" : 12.787695,
        "_source" : {
          "type" : "line",
          "line_id" : 8516,
          "play_name" : "Henry VI Part 2",
          "speech_number" : 23,
          "line_number" : "4.2.36",
          "speaker" : "CADE",
          "text_entry" : "My mother a Plantagenet,--"
        }
      }
    ]
  }
}
~~~



### 4. match_phrase_prefix Query

- match_phrase 와 동일한 방식으로 문서 검색
- 마지막 문자를 와일드 카드 형태로 검색

~~~
# match_phrase_prefix : 뒤에 있는 단어를 마치 와일드카드처럼 사용
POST shakespeare/_search
{
  "query": {
    "match_phrase_prefix": {
      "text_entry": "my mother d"
    }
  }
}


{
  "took" : 10,
  "timed_out" : false,
  "_shards" : {
    "total" : 3,
    "successful" : 3,
    "skipped" : 0,
    "failed" : 0
  },
  "hits" : {
    "total" : {
      "value" : 1,
      "relation" : "eq"
    },
    "max_score" : 12.787695,
    "hits" : [
      {
        "_index" : "shakespeare",
        "_type" : "doc",
        "_id" : "o1uXTXABDdPMBukX1-T6",
        "_score" : 12.787695,
        "_source" : {
          "type" : "line",
          "line_id" : 8516,
          "play_name" : "Henry VI Part 2",
          "speech_number" : 23,
          "line_number" : "4.2.36",
          "speaker" : "CADE",
          "text_entry" : "My mother a Plantagenet,--"
        }
      }
    ]
  }
}
~~~



### 5. multi match Query

- fields parameter 에 정의된 field 들에서 검색
- match 쿼리를 여러개의 필드들에 대해서 검색

~~~
## document 인덱싱
POST multi_match_index/_doc
{
  "name": "ElasticSearch Engine",
  "comment": "It's Best Solution"
}

## document 인덱싱
POST multi_match_index/_doc
{
  "name": "Mongo DB",
  "comment": "What is difference ElasticSearch Engine"
}


## 검색은 Engine, 필드는 name과 comment
POST multi_match_index/_search
{
  "query": {
    "multi_match": {
      "query": "Engine",
      "fields": [
        "name",
        "comment"
      ]
    }
  }
}


{
  "took" : 5,
  "timed_out" : false,
  "_shards" : {
    "total" : 3,
    "successful" : 3,
    "skipped" : 0,
    "failed" : 0
  },
  "hits" : {
    "total" : {
      "value" : 2,
      "relation" : "eq"
    },
    "max_score" : 0.6931472,
    "hits" : [
      {
        "_index" : "multi_match_index",
        "_type" : "_doc",
        "_id" : "C1zfTXABDdPMBukXoSVm",
        "_score" : 0.6931472,
        "_source" : {
          "name" : "ElasticSearch Engine",
          "comment" : "It's Best Solution"
        }
      },
      {
        "_index" : "multi_match_index",
        "_type" : "_doc",
        "_id" : "DFzfTXABDdPMBukXsyUl",
        "_score" : 0.62883455,
        "_source" : {
          "name" : "Mongo DB",
          "comment" : "What is difference ElasticSearch Engine"
        }
      }
    ]
  }
}
~~~



### 6. query string Query

- match, multi_match, match_phrase_prefix 의 기능을 할 수 있는 쿼리
- match_phrase_prefix 기능은 와일드카드(*) 추가로 가능

~~~
POST shakespeare/_search
{
  "query": {
    "query_string": {
      "query": "henry VI*",
      "fields": [
        "text_entry",
        "play_name"
      ]
    }
  }
}


{
  "took" : 32,
  "timed_out" : false,
  "_shards" : {
    "total" : 3,
    "successful" : 3,
    "skipped" : 0,
    "failed" : 0
  },
  "hits" : {
    "total" : {
      "value" : 10000,
      "relation" : "gte"
    },
    "max_score" : 7.129874,
    "hits" : [
      {
        "_index" : "shakespeare",
        "_type" : "doc",
        "_id" : "KluXTXABDdPMBukX1-L5",
        "_score" : 7.129874,
        "_source" : {
          "type" : "line",
          "line_id" : 7883,
          "play_name" : "Henry VI Part 2",
          "speech_number" : 16,
          "line_number" : "",
          "speaker" : "CARDINAL",
          "text_entry" : "KING HENRY VI swoons"
        }
      },
      {
        "_index" : "shakespeare",
        "_type" : "doc",
        "_id" : "BFuXTXABDdPMBukX2PEA",
        "_score" : 6.838947,
        "_source" : {
          "type" : "line",
          "line_id" : 11685,
          "play_name" : "Henry VI Part 3",
          "speech_number" : 3,
          "line_number" : "4.2.27",
          "speaker" : "WARWICK",
          "text_entry" : "They all cry, Henry!"
        }
      },
      {
        "_index" : "shakespeare",
        "_type" : "doc",
        "_id" : "6VuXTXABDdPMBukX1-j8",
        "_score" : 6.7403784,
        "_source" : {
          "type" : "line",
          "line_id" : 9610,
          "play_name" : "Henry VI Part 3",
          "speech_number" : 33,
          "line_number" : "1.1.82",
          "speaker" : "WARWICK",
          "text_entry" : "In following this usurping Henry."
        }
      },
      {
        "_index" : "shakespeare",
        "_type" : "doc",
        "_id" : "S1uXTXABDdPMBukX1-n8",
        "_score" : 6.646255,
        "_source" : {
          "type" : "line",
          "line_id" : 9708,
          "play_name" : "Henry VI Part 3",
          "speech_number" : 83,
          "line_number" : "1.1.179",
          "speaker" : "WESTMORELAND",
          "text_entry" : "Base, fearful and despairing Henry!"
        }
      },
      {
        "_index" : "shakespeare",
        "_type" : "doc",
        "_id" : "e1uXTXABDdPMBukX1-3_",
        "_score" : 6.646255,
        "_source" : {
          "type" : "line",
          "line_id" : 10780,
          "play_name" : "Henry VI Part 3",
          "speech_number" : 1,
          "line_number" : "2.6.7",
          "speaker" : "CLIFFORD",
          "text_entry" : "Impairing Henry, strengthening misproud York,"
        }
      },
      {
        "_index" : "shakespeare",
        "_type" : "doc",
        "_id" : "hluXTXABDdPMBukX18rr",
        "_score" : 6.5824065,
        "_source" : {
          "type" : "line",
          "line_id" : 1831,
          "play_name" : "Henry IV",
          "speech_number" : 74,
          "line_number" : "",
          "speaker" : "MORTIMER",
          "text_entry" : "Enter KING HENRY IV, PRINCE HENRY, and others"
        }
      },
      {
        "_index" : "shakespeare",
        "_type" : "doc",
        "_id" : "D1uXTXABDdPMBukX18zs",
        "_score" : 6.5760736,
        "_source" : {
          "type" : "line",
          "line_id" : 2224,
          "play_name" : "Henry IV",
          "speech_number" : 80,
          "line_number" : "",
          "speaker" : "PRINCE HENRY",
          "text_entry" : "Exit PRINCE HENRY"
        }
      },
      {
        "_index" : "shakespeare",
        "_type" : "doc",
        "_id" : "3FuXTXABDdPMBukX187v",
        "_score" : 6.5760736,
        "_source" : {
          "type" : "line",
          "line_id" : 2941,
          "play_name" : "Henry IV",
          "speech_number" : 15,
          "line_number" : "",
          "speaker" : "FALSTAFF",
          "text_entry" : "Enter PRINCE HENRY"
        }
      },
      {
        "_index" : "shakespeare",
        "_type" : "doc",
        "_id" : "CluXTXABDdPMBukX19n0",
        "_score" : 6.3974233,
        "_source" : {
          "type" : "line",
          "line_id" : 5547,
          "play_name" : "Henry VI Part 1",
          "speech_number" : 14,
          "line_number" : "4.7.70",
          "speaker" : "LUCY",
          "text_entry" : "Great marshal to Henry the Sixth"
        }
      },
      {
        "_index" : "shakespeare",
        "_type" : "doc",
        "_id" : "ZVuXTXABDdPMBukX19v1",
        "_score" : 6.3974233,
        "_source" : {
          "type" : "line",
          "line_id" : 6150,
          "play_name" : "Henry VI Part 1",
          "speech_number" : 10,
          "line_number" : "5.5.73",
          "speaker" : "SUFFOLK",
          "text_entry" : "For Henry, son unto a conqueror,"
        }
      }
    ]
  }
}
~~~





## Term Level Query(Filter Context 로 주로 쓰이는 쿼리)

- **정확히 일치하는 용어만 검색, analyze 되지 않음(하나의 토큰만 생성), 범위 검색**
- 정확히 일치하는 문서만 검색되기 때문에 **_score 는 무의미하나 스코어링이 되지 않는 것은 아님**
- **쿼리로 사용하는 전체 문자열을 기준으로 정확히 일치하는 token이 있는 경우에만 검색이 가능**
- **keyword field 기반으로 검색**
  - date 필드의 값이 2015년과 2018년 사이에 속해있는지 등...
- 각 쿼리는 key:value 형태로 바로 검색하거나 쿼리 종류별로 제공하는 parameter 는 사용할 수 있음
- **term, terms, range 등**
- **쿼리 종류**
  - https://www.elastic.co/guide/en/elasticsearch/reference/current/term-level-queries.html
- **쿼리 별 파라미터**
  - Term Level Query 는 parameter 가 다양하지 않아 각 쿼리문에서 확인



### 1. term Query

- 역색인 된 토큰 중에 term 이 정확히 일치할때만 결과를 리턴
- keyword 필드에 대해서만 쿼리 가능
- 아래의 예제는 dynamic indexing 된 sub field 인 {field}.keyword 를 사용하는 것을 전제로함
- mapping 시 keyword 로 미리 설정이 되었다면 "gender": "M" 형태로 검색
- key:value 형태 검색

~~~
### keyword 필드로 검색 : term은 정확히 일치해야 함
### 스코어가 전부 같음
## 1. term쿼리
POST shakespeare/_search
{
  "query": {
    "term": {
      "play_name.keyword": "Henry IV"
    }
  }
}

## 2. term쿼리
# 1번 쿼리와 똑같은 결과를 리턴함(스코어가 없기 때문)
POST shakespeare/_search
{
  "query": {
    "term": {
      "play_name.keyword": {
        "value": "Henry IV",
        "boost": 2.0
      }
    }
  }
}


{
  "took" : 8,
  "timed_out" : false,
  "_shards" : {
    "total" : 3,
    "successful" : 3,
    "skipped" : 0,
    "failed" : 0
  },
  "hits" : {
    "total" : {
      "value" : 3203,
      "relation" : "eq"
    },
    "max_score" : 2.0982885,
    "hits" : [
      {
        "_index" : "shakespeare",
        "_type" : "doc",
        "_id" : "YFuXTXABDdPMBukX18Pj",
        "_score" : 2.0982885,
        "_source" : {
          "type" : "act",
          "line_id" : 1,
          "play_name" : "Henry IV",
          "speech_number" : "",
          "line_number" : "",
          "speaker" : "",
          "text_entry" : "ACT I"
        }
      },
      {
        "_index" : "shakespeare",
        "_type" : "doc",
        "_id" : "ZFuXTXABDdPMBukX18Pj",
        "_score" : 2.0982885,
        "_source" : {
          "type" : "line",
          "line_id" : 5,
          "play_name" : "Henry IV",
          "speech_number" : 1,
          "line_number" : "1.1.2",
          "speaker" : "KING HENRY IV",
          "text_entry" : "Find we a time for frighted peace to pant,"
        }
      },
      {
        "_index" : "shakespeare",
        "_type" : "doc",
        "_id" : "Z1uXTXABDdPMBukX18Pj",
        "_score" : 2.0982885,
        "_source" : {
          "type" : "line",
          "line_id" : 8,
          "play_name" : "Henry IV",
          "speech_number" : 1,
          "line_number" : "1.1.5",
          "speaker" : "KING HENRY IV",
          "text_entry" : "No more the thirsty entrance of this soil"
        }
      },
      {
        "_index" : "shakespeare",
        "_type" : "doc",
        "_id" : "a1uXTXABDdPMBukX18Pj",
        "_score" : 2.0982885,
        "_source" : {
          "type" : "line",
          "line_id" : 12,
          "play_name" : "Henry IV",
          "speech_number" : 1,
          "line_number" : "1.1.9",
          "speaker" : "KING HENRY IV",
          "text_entry" : "Of hostile paces: those opposed eyes,"
        }
      },
      {
        "_index" : "shakespeare",
        "_type" : "doc",
        "_id" : "bFuXTXABDdPMBukX18Pj",
        "_score" : 2.0982885,
        "_source" : {
          "type" : "line",
          "line_id" : 13,
          "play_name" : "Henry IV",
          "speech_number" : 1,
          "line_number" : "1.1.10",
          "speaker" : "KING HENRY IV",
          "text_entry" : "Which, like the meteors of a troubled heaven,"
        }
      },
      {
        "_index" : "shakespeare",
        "_type" : "doc",
        "_id" : "dFuXTXABDdPMBukX18Pj",
        "_score" : 2.0982885,
        "_source" : {
          "type" : "line",
          "line_id" : 21,
          "play_name" : "Henry IV",
          "speech_number" : 1,
          "line_number" : "1.1.18",
          "speaker" : "KING HENRY IV",
          "text_entry" : "No more shall cut his master. Therefore, friends,"
        }
      },
      {
        "_index" : "shakespeare",
        "_type" : "doc",
        "_id" : "dluXTXABDdPMBukX18Pj",
        "_score" : 2.0982885,
        "_source" : {
          "type" : "line",
          "line_id" : 23,
          "play_name" : "Henry IV",
          "speech_number" : 1,
          "line_number" : "1.1.20",
          "speaker" : "KING HENRY IV",
          "text_entry" : "Whose soldier now, under whose blessed cross"
        }
      },
      {
        "_index" : "shakespeare",
        "_type" : "doc",
        "_id" : "fFuXTXABDdPMBukX18Pj",
        "_score" : 2.0982885,
        "_source" : {
          "type" : "line",
          "line_id" : 29,
          "play_name" : "Henry IV",
          "speech_number" : 1,
          "line_number" : "1.1.26",
          "speaker" : "KING HENRY IV",
          "text_entry" : "Which fourteen hundred years ago were naild"
        }
      },
      {
        "_index" : "shakespeare",
        "_type" : "doc",
        "_id" : "fVuXTXABDdPMBukX18Pj",
        "_score" : 2.0982885,
        "_source" : {
          "type" : "line",
          "line_id" : 30,
          "play_name" : "Henry IV",
          "speech_number" : 1,
          "line_number" : "1.1.27",
          "speaker" : "KING HENRY IV",
          "text_entry" : "For our advantage on the bitter cross."
        }
      },
      {
        "_index" : "shakespeare",
        "_type" : "doc",
        "_id" : "gluXTXABDdPMBukX18Pj",
        "_score" : 2.0982885,
        "_source" : {
          "type" : "line",
          "line_id" : 35,
          "play_name" : "Henry IV",
          "speech_number" : 1,
          "line_number" : "1.1.32",
          "speaker" : "KING HENRY IV",
          "text_entry" : "What yesternight our council did decree"
        }
      }
    ]
  }
}
~~~



### 2. terms Query

- 10000개를 검색
- 복수의 검색어 : YORK, KING HENRY IV

~~~
POST shakespeare/_search
{
  "from":0, "size": 10000,
  "query": {
    "terms": {
      "speaker.keyword": [
        "YORK",
        "KING HENRY IV"
      ]
    }
  }
}


{
  "took" : 45,
  "timed_out" : false,
  "_shards" : {
    "total" : 3,
    "successful" : 3,
    "skipped" : 0,
    "failed" : 0
  },
  "hits" : {
    "total" : {
      "value" : 1054,
      "relation" : "eq"
    },
    "max_score" : 1.0,
    "hits" : [
      {
        "_index" : "shakespeare",
        "_type" : "doc",
        "_id" : "aVuXTXABDdPMBukX18Pj",
        "_score" : 1.0,
        "_source" : {
          "type" : "line",
          "line_id" : 10,
          "play_name" : "Henry IV",
          "speech_number" : 1,
          "line_number" : "1.1.7",
          "speaker" : "KING HENRY IV",
          "text_entry" : "Nor more shall trenching war channel her fields,"
        }
      },
      {
        "_index" : "shakespeare",
        "_type" : "doc",
        "_id" : "bVuXTXABDdPMBukX18Pj",
        "_score" : 1.0,
        "_source" : {
          "type" : "line",
          "line_id" : 14,
          "play_name" : "Henry IV",
          "speech_number" : 1,
          "line_number" : "1.1.11",
          "speaker" : "KING HENRY IV",
          "text_entry" : "All of one nature, of one substance bred,"
        }
      },
      ...
      ...
      ...
~~~



### 3. range Query

- numeric, date, geo field 에 대해서만 가능
- gte(greater than || equal), gt, gle(less than || equal), lt 파라미터 사용

~~~
# range
## line_id 250 ~ 259
POST shakespeare/_search
{
  "query": {
    "range": {
      "line_id": {
        "gte": 250,
        "lte": 259
      }
    }
  }
}


{
  "took" : 24,
  "timed_out" : false,
  "_shards" : {
    "total" : 3,
    "successful" : 3,
    "skipped" : 0,
    "failed" : 0
  },
  "hits" : {
    "total" : {
      "value" : 10,
      "relation" : "eq"
    },
    "max_score" : 1.0,
    "hits" : [
      {
        "_index" : "shakespeare",
        "_type" : "doc",
        "_id" : "WluXTXABDdPMBukX18Tk",
        "_score" : 1.0,
        "_source" : {
          "type" : "line",
          "line_id" : 251,
          "play_name" : "Henry IV",
          "speech_number" : 46,
          "line_number" : "1.2.136",
          "speaker" : "FALSTAFF",
          "text_entry" : "Why, thats well said."
        }
      },
      {
        "_index" : "shakespeare",
        "_type" : "doc",
        "_id" : "XFuXTXABDdPMBukX18Tk",
        "_score" : 1.0,
        "_source" : {
          "type" : "line",
          "line_id" : 253,
          "play_name" : "Henry IV",
          "speech_number" : 48,
          "line_number" : "1.2.138",
          "speaker" : "FALSTAFF",
          "text_entry" : "By the Lord, Ill be a traitor then, when thou art king."
        }
      },
      {
        "_index" : "shakespeare",
        "_type" : "doc",
        "_id" : "XVuXTXABDdPMBukX18Tk",
        "_score" : 1.0,
        "_source" : {
          "type" : "line",
          "line_id" : 254,
          "play_name" : "Henry IV",
          "speech_number" : 49,
          "line_number" : "1.2.139",
          "speaker" : "PRINCE HENRY",
          "text_entry" : "I care not."
        }
      },
      {
        "_index" : "shakespeare",
        "_type" : "doc",
        "_id" : "XluXTXABDdPMBukX18Tk",
        "_score" : 1.0,
        "_source" : {
          "type" : "line",
          "line_id" : 255,
          "play_name" : "Henry IV",
          "speech_number" : 50,
          "line_number" : "1.2.140",
          "speaker" : "POINS",
          "text_entry" : "Sir John, I prithee, leave the prince and me alone:"
        }
      },
      {
        "_index" : "shakespeare",
        "_type" : "doc",
        "_id" : "YVuXTXABDdPMBukX18Tk",
        "_score" : 1.0,
        "_source" : {
          "type" : "line",
          "line_id" : 258,
          "play_name" : "Henry IV",
          "speech_number" : 51,
          "line_number" : "1.2.143",
          "speaker" : "FALSTAFF",
          "text_entry" : "Well, God give thee the spirit of persuasion and him"
        }
      },
      {
        "_index" : "shakespeare",
        "_type" : "doc",
        "_id" : "YluXTXABDdPMBukX18Tk",
        "_score" : 1.0,
        "_source" : {
          "type" : "line",
          "line_id" : 259,
          "play_name" : "Henry IV",
          "speech_number" : 51,
          "line_number" : "1.2.144",
          "speaker" : "FALSTAFF",
          "text_entry" : "the ears of profiting, that what thou speakest may"
        }
      },
      {
        "_index" : "shakespeare",
        "_type" : "doc",
        "_id" : "X1uXTXABDdPMBukX18Tk",
        "_score" : 1.0,
        "_source" : {
          "type" : "line",
          "line_id" : 256,
          "play_name" : "Henry IV",
          "speech_number" : 50,
          "line_number" : "1.2.141",
          "speaker" : "POINS",
          "text_entry" : "I will lay him down such reasons for this adventure"
        }
      },
      {
        "_index" : "shakespeare",
        "_type" : "doc",
        "_id" : "YFuXTXABDdPMBukX18Tk",
        "_score" : 1.0,
        "_source" : {
          "type" : "line",
          "line_id" : 257,
          "play_name" : "Henry IV",
          "speech_number" : 50,
          "line_number" : "1.2.142",
          "speaker" : "POINS",
          "text_entry" : "that he shall go."
        }
      },
      {
        "_index" : "shakespeare",
        "_type" : "doc",
        "_id" : "WVuXTXABDdPMBukX18Tk",
        "_score" : 1.0,
        "_source" : {
          "type" : "line",
          "line_id" : 250,
          "play_name" : "Henry IV",
          "speech_number" : 45,
          "line_number" : "1.2.135",
          "speaker" : "PRINCE HENRY",
          "text_entry" : "Well then, once in my days Ill be a madcap."
        }
      },
      {
        "_index" : "shakespeare",
        "_type" : "doc",
        "_id" : "W1uXTXABDdPMBukX18Tk",
        "_score" : 1.0,
        "_source" : {
          "type" : "line",
          "line_id" : 252,
          "play_name" : "Henry IV",
          "speech_number" : 47,
          "line_number" : "1.2.137",
          "speaker" : "PRINCE HENRY",
          "text_entry" : "Well, come what will, Ill tarry at home."
        }
      }
    ]
  }
}
~~~





### 4. wildcard Query

~~~
# wildcard
POST shakespeare/_search
{
  "query": {
    "wildcard": {
      "speaker.keyword": "KING HENR*"
    }
  }
}


{
  "took" : 43,
  "timed_out" : false,
  "_shards" : {
    "total" : 3,
    "successful" : 3,
    "skipped" : 0,
    "failed" : 0
  },
  "hits" : {
    "total" : {
      "value" : 1273,
      "relation" : "eq"
    },
    "max_score" : 1.0,
    "hits" : [
      {
        "_index" : "shakespeare",
        "_type" : "doc",
        "_id" : "aVuXTXABDdPMBukX18Pj",
        "_score" : 1.0,
        "_source" : {
          "type" : "line",
          "line_id" : 10,
          "play_name" : "Henry IV",
          "speech_number" : 1,
          "line_number" : "1.1.7",
          "speaker" : "KING HENRY IV",
          "text_entry" : "Nor more shall trenching war channel her fields,"
        }
      },
      {
        "_index" : "shakespeare",
        "_type" : "doc",
        "_id" : "bVuXTXABDdPMBukX18Pj",
        "_score" : 1.0,
        "_source" : {
          "type" : "line",
          "line_id" : 14,
          "play_name" : "Henry IV",
          "speech_number" : 1,
          "line_number" : "1.1.11",
          "speaker" : "KING HENRY IV",
          "text_entry" : "All of one nature, of one substance bred,"
        }
      },
      {
        "_index" : "shakespeare",
        "_type" : "doc",
        "_id" : "b1uXTXABDdPMBukX18Pj",
        "_score" : 1.0,
        "_source" : {
          "type" : "line",
          "line_id" : 16,
          "play_name" : "Henry IV",
          "speech_number" : 1,
          "line_number" : "1.1.13",
          "speaker" : "KING HENRY IV",
          "text_entry" : "And furious close of civil butchery"
        }
      },
      {
        "_index" : "shakespeare",
        "_type" : "doc",
        "_id" : "cFuXTXABDdPMBukX18Pj",
        "_score" : 1.0,
        "_source" : {
          "type" : "line",
          "line_id" : 17,
          "play_name" : "Henry IV",
          "speech_number" : 1,
          "line_number" : "1.1.14",
          "speaker" : "KING HENRY IV",
          "text_entry" : "Shall now, in mutual well-beseeming ranks,"
        }
      },
      {
        "_index" : "shakespeare",
        "_type" : "doc",
        "_id" : "cluXTXABDdPMBukX18Pj",
        "_score" : 1.0,
        "_source" : {
          "type" : "line",
          "line_id" : 19,
          "play_name" : "Henry IV",
          "speech_number" : 1,
          "line_number" : "1.1.16",
          "speaker" : "KING HENRY IV",
          "text_entry" : "Against acquaintance, kindred and allies:"
        }
      },
      {
        "_index" : "shakespeare",
        "_type" : "doc",
        "_id" : "c1uXTXABDdPMBukX18Pj",
        "_score" : 1.0,
        "_source" : {
          "type" : "line",
          "line_id" : 20,
          "play_name" : "Henry IV",
          "speech_number" : 1,
          "line_number" : "1.1.17",
          "speaker" : "KING HENRY IV",
          "text_entry" : "The edge of war, like an ill-sheathed knife,"
        }
      },
      {
        "_index" : "shakespeare",
        "_type" : "doc",
        "_id" : "d1uXTXABDdPMBukX18Pj",
        "_score" : 1.0,
        "_source" : {
          "type" : "line",
          "line_id" : 24,
          "play_name" : "Henry IV",
          "speech_number" : 1,
          "line_number" : "1.1.21",
          "speaker" : "KING HENRY IV",
          "text_entry" : "We are impressed and engaged to fight,"
        }
      },
      {
        "_index" : "shakespeare",
        "_type" : "doc",
        "_id" : "eFuXTXABDdPMBukX18Pj",
        "_score" : 1.0,
        "_source" : {
          "type" : "line",
          "line_id" : 25,
          "play_name" : "Henry IV",
          "speech_number" : 1,
          "line_number" : "1.1.22",
          "speaker" : "KING HENRY IV",
          "text_entry" : "Forthwith a power of English shall we levy;"
        }
      },
      {
        "_index" : "shakespeare",
        "_type" : "doc",
        "_id" : "eluXTXABDdPMBukX18Pj",
        "_score" : 1.0,
        "_source" : {
          "type" : "line",
          "line_id" : 27,
          "play_name" : "Henry IV",
          "speech_number" : 1,
          "line_number" : "1.1.24",
          "speaker" : "KING HENRY IV",
          "text_entry" : "To chase these pagans in those holy fields"
        }
      },
      {
        "_index" : "shakespeare",
        "_type" : "doc",
        "_id" : "e1uXTXABDdPMBukX18Pj",
        "_score" : 1.0,
        "_source" : {
          "type" : "line",
          "line_id" : 28,
          "play_name" : "Henry IV",
          "speech_number" : 1,
          "line_number" : "1.1.25",
          "speaker" : "KING HENRY IV",
          "text_entry" : "Over whose acres walkd those blessed feet"
        }
      }
    ]
  }
}
~~~

